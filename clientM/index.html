
<canvas id="ctx" width="1300" height="700" style="border:1px solid #000000"></canvas>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/addons/p5.dom.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/addons/p5.sound.min.js"></script> -->
  <!-- <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script> -->
  <div style="display:none;">
    <img id="sourceR" src="clientM/img/goblinR.png" width="300" height="227" />
  </div>
  <div style="display:none;">
    <img id="sourceL" src="clientM/img/goblinL.png" width="300" height="227" />
  </div>
  <div style="display:none;">
    <img id="jungle" src="clientM/img/jungle.jfif" width="300" height="227" />
  </div>
  <div style="display:none;">
    <img id="tile" src="clientM/img/tile.png" width="70" height="70" />
  </div>
<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io();
    var ctx = document.getElementById("ctx").
    getContext("2d");
    ctx.font = '30px Arial';
    var tr = 0;
    const screenWidth = 1300;
    const screenHeight = 900;
    var width = 2000;
    var height = 1500;
    var characterWidth = 100;
    var characterHeight = 100;
    var hitboxRatioXHalf = 0.3;
    var hitboxRatioUpperHalf = 0.5;
    var groundWidth = 2000; //must be a multiple of tileSize and synced with server values
    var groundHeight = 800;
    var tileSize = 10;
    var gridWidth = groundWidth / tileSize;
    var gridHeight = groundHeight / tileSize;
    var myX = width/2;
    var myY = height/2;
    var lastMouseX = width/2;
    var lastMouseY = height/2;
    var goblinR = document.getElementById("sourceR");
    var goblinL = document.getElementById("sourceL");
    var jungle = document.getElementById("jungle");
    var tile = document.getElementById("tile");
    var usedGoblin = goblinR;

    socket.on('newPositions', function(data) {
        ctx.clearRect(0,0,width,height);
        myX = data.personal.x;
        myY = data.personal.y;

        drawImageCentered(jungle, 0, 0, width, height); 

        for(var i  = 0; i < data.players.length; i ++) {
            if (data.players[i].facingLeft)
                usedGoblin = goblinL;
            else usedGoblin = goblinR;
        //     ctx.drawImage(usedGoblin, data.players[i].x - characterWidth/2,
        //                     data.players[i].y - characterHeight/2 , characterWidth, characterHeight);
        // }
        drawImageCentered(usedGoblin, data.players[i].x - characterWidth/2,
                            data.players[i].y - characterHeight/2, characterWidth, characterHeight);
        }

        drawRectCentered(myX - characterWidth * hitboxRatioXHalf, myY - characterHeight / 2 * (1 - hitboxRatioUpperHalf),
                    characterWidth * 2 * hitboxRatioXHalf, characterHeight * (0.5 + 0.5 * hitboxRatioUpperHalf), "stroke")
        //hitbox

        
        for (var i = 0; i < groundHeight / tileSize; i ++) {
            for (var j = 0; j < groundWidth / tileSize; j ++) {
                if (!data.ground[i][j].mined) {
                    drawImageCentered(tile, j * tileSize, (height - groundHeight) + i * tileSize , tileSize, tileSize);  
                   
                    //drawRectCentered(j * tileSize, (height - groundHeight) + i * tileSize , tileSize, tileSize, "fill");
                }
            }
        }
        ht = data.personal.hoveredTile;
        if (ht.enabled && !data.ground[ht.y][ht.x].mined) {
            affectedTile = data.ground[ht.y][ht.x];
            if (ht.isBeingMined) {
                drawRectCentered(ht.x * tileSize, (height - groundHeight) + ht.y * tileSize , tileSize, tileSize * (affectedTile.maxHp - affectedTile.hp)/ affectedTile.maxHp, "fill");
            }
            drawRectCentered(ht.x * tileSize, (height - groundHeight) + ht.y * tileSize , tileSize, tileSize, "stroke");    
        }
    });


    document.body.onmousedown = function(event) {
        socket.emit('mouseDown');
    }

    document.body.onmouseup = function(event) {
        mousePressed = false;
        socket.emit('mouseUp');
    }

    document.onmousemove = function(event) {
        const mouseX = event.offsetX;
        const mouseY = event.offsetY;
        socket.emit('mouseMoved', {x: mouseX - centerOffsetX(), y: mouseY - (screenHeight / 2 - myY)});
  };

    document.onkeydown = function(event) {
        if(event.keyCode == 68) {
            socket.emit('keyPress', {inputId: 'right', state: true});
        }
        else if(event.keyCode == 83)
            socket.emit('keyPress', {inputId: 'down', state: true});
        else if(event.keyCode == 65) {
            socket.emit('keyPress', {inputId: 'left', state: true});
        }
        else if(event.keyCode == 87)
            socket.emit('keyPress', {inputId: 'up', state: true});   
    }

    
    document.onkeyup = function(event) {
        if(event.keyCode == 68)
            socket.emit('keyPress', {inputId: 'right', state: false});
        else if(event.keyCode == 83)
            socket.emit('keyPress', {inputId: 'down', state: false});
        else if(event.keyCode == 65)
            socket.emit('keyPress', {inputId: 'left', state: false});
        else if(event.keyCode == 87)
            socket.emit('keyPress', {inputId: 'up', state: false});   
    }
   

    function centerOffsetX() {
        if (width - myX < screenWidth / 2 )
            return screenWidth - width;
        else if (myX < screenWidth / 2)
            return 0;
        return (screenWidth / 2 - myX);
    }

    function drawImageCentered(img, x, y, sizex, sizey) {
        ctx.drawImage(img, x  + centerOffsetX(), y + (screenHeight / 2 - myY), sizex, sizey);
    }

    function drawRectCentered(x, y, sizex, sizey, type) {
        ctx.beginPath();
        ctx.rect( x  + centerOffsetX(), y + (screenHeight / 2 - myY), sizex, sizey);
        if (type == "stroke")
            ctx.stroke();
        else if (type == "fill")
            ctx.fill();
    }
</script>
